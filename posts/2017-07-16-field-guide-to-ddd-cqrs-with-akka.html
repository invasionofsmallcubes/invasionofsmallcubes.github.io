<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="description" content="this is my note taking app, shared with everybody"/><meta property="og:image" content="https://og-image.now.sh/Welcome%20to%20the%20Invasion%20Of%20Small%20Cubes.png?theme=dark&amp;md=0&amp;fontSize=75px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><meta name="og:title" content="Welcome to the Invasion Of Small Cubes"/><meta name="twitter:card" content="summary_large_image"/><title>Field Guide to DDD/CQRS With Akka</title><meta name="next-head-count" content="8"/><link rel="preload" href="/_next/static/css/62b896be71e756bbd967.css" as="style"/><link rel="stylesheet" href="/_next/static/css/62b896be71e756bbd967.css"/><link rel="preload" href="/_next/static/css/58699b1a35406fdf6fc5.css" as="style"/><link rel="stylesheet" href="/_next/static/css/58699b1a35406fdf6fc5.css"/><link rel="preload" href="/_next/static/chunks/main-09a35a1efccce928cb9e.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-ccf5ab034a524403276a.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.5e03480598ad1120f007.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.dee2ffe8ab5f8852fbb0.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-693a52f134959e79e2e2.js" as="script"/><link rel="preload" href="/_next/static/chunks/10cf003e655e7be2119574cd9202224517114f06.88faf2b206d9aa1def0c.js" as="script"/><link rel="preload" href="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.59a0c659b24f5cfac152.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-9447264b1c0cf8b6e875.js" as="script"/></head><body><div id="__next"><div class="layout_container__2t4v2"><header class="layout_header__2rhWq"><a href="/"><img src="/images/face.jpeg" class="layout_headerImage__2h5On utils_borderCircle__13qdJ" alt="The Invasion of Small Cubes"/></a><h2 class="utils_headingLg__de7p0"><a class="utils_colorInherit__3Gudf" href="/">The Invasion of Small Cubes</a></h2></header><main><article><h1 class="utils_headingXl__1XecN">Field Guide to DDD/CQRS With Akka</h1><div class="utils_lightText__12Ckm"><time dateTime="2017-07-16">July 16, 2017</time></div><div><h2>Notes on &quot;field Guide to DDD/CQRS with Akka&quot;</h2><p>This is are the notes as seen on this talk at Devoxxx Belgium:</p><span><iframe width="560" height="315" src="https://www.youtube.com/embed/fQkKu4tTgCE?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allowfullscreen></iframe></span><p>Let&#x27;s begin</p><ul><li>aggregate is responsible for consistency <em>(DDD)</em></li><li>you can only modify one aggregate per transaction <em>(DDD)</em></li><li>write model receives commands and produce events <em>(CQRS)</em></li><li>strict consistency on write model side <em>(DDD/CQRS)</em></li><li>read models are created from events <em>(CQRS)</em></li><li>eventual consistency if asynch <em>(CQRS/ES)</em></li><li>events can be stored and replayed (ES)</li></ul><p>Now we will se what operation we should implement for CQRS (in a non-reactive way)</p><pre style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd;padding:1em;margin:.5em 0;overflow:auto"><code style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd"><span class="token" style="color:#ffcc99">trait</span><span> DomainCommand
</span><span></span><span class="token" style="color:#ffcc99">trait</span><span> DomainEvent
</span><span></span><span class="token" style="color:#ffcc99">trait</span><span> Aggregate
</span>
<span></span><span class="token" style="color:#ffcc99">trait</span><span> Behavior </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>  </span><span class="token" style="color:#6c6783">// this is part of the constructor</span><span>
</span><span>  </span><span class="token" style="color:#6c6783">// it has to validate the DomainComman then it produces an event</span><span>
</span><span>  </span><span class="token" style="color:#6c6783">// only if DomainCommand is valid</span><span>
</span><span>  </span><span class="token" style="color:#ffcc99">def</span><span> validate</span><span class="token" style="color:#6c6783">(</span><span>cmd</span><span class="token" style="color:#e09142">:</span><span> DomainCommand</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#e09142">:</span><span> DomainEvent
</span>
<span>  </span><span class="token" style="color:#6c6783">// once the first event is created we use this method to creat an aggregate</span><span>
</span><span>  </span><span class="token" style="color:#ffcc99">def</span><span> applyEvent</span><span class="token" style="color:#6c6783">(</span><span>evt</span><span class="token" style="color:#e09142">:</span><span> DomainEvent</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#e09142">:</span><span> Aggregate
</span>
<span>  </span><span class="token" style="color:#6c6783">// we have to separate method because:</span><span>
</span><span>  </span><span class="token" style="color:#6c6783">// 1) we want to write code between validation and application of an event</span><span>
</span><span>  </span><span class="token" style="color:#6c6783">// 2) in case of replay, we don&#x27;t have commands, just events</span><span>
</span>
<span>  </span><span class="token" style="color:#6c6783">// this method validates a command against an existing aggregate</span><span>
</span><span>  </span><span class="token" style="color:#ffcc99">def</span><span> validate</span><span class="token" style="color:#6c6783">(</span><span>cmd</span><span class="token" style="color:#e09142">:</span><span> DomainCommand</span><span class="token" style="color:#6c6783">,</span><span> agg</span><span class="token" style="color:#e09142">:</span><span> Aggregate</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#e09142">:</span><span> DomainEvent
</span>
<span>  </span><span class="token" style="color:#6c6783">// application of an event on the aggregate</span><span>
</span><span>  </span><span class="token" style="color:#6c6783">// aggregate is immutable, so we produce a new aggregate every time we use this apply event</span><span>
</span><span>  </span><span class="token" style="color:#ffcc99">def</span><span> applyEvent</span><span class="token" style="color:#6c6783">(</span><span>evt</span><span class="token" style="color:#e09142">:</span><span> DomainEvent</span><span class="token" style="color:#6c6783">,</span><span> agg</span><span class="token" style="color:#e09142">:</span><span> Aggregate</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#e09142">:</span><span> Aggregate
</span><span></span><span class="token" style="color:#6c6783">}</span></code></pre><p>In Akka the main component is a <code>PartialFunction[Any,Unit]</code> that will consume any type and will return a <code>Unit</code> . It&#x27;s too broad and we know, given a command in input, which domain we will produce.</p><p>Akka is an actor system. We send messages to an <em>actor</em> which we cannot manipulate directly, we use its <code>ActorRef</code>.</p><p>The message will go to the <code>Actor</code> mailbox and the <code>Actor</code> will consume it when it is ready to do so.</p><p>An <code>Actor</code>can have an internal mutable state but it cannot be accessed from outside.</p><p>An <code>Actor</code> stays in memory until dies or it&#x27;s terminated. With <code>Akka Persistence</code> we can save the events we send after processing a message and so we can then recover a state.</p><p>An <code>Actor</code> has a receive method that can handle messages that comes from the system. If that <code>Actor</code> will receive a message it cannot handle, will just ignore it. It will send it to a <em>dead letter queue</em>.</p><p>The <code>Actor</code> will collect messages in the <code>Mailbox</code> until it is not ready to read another one. In the <code>Mailbox</code> messages are kept in order of arrival. <code>Akka</code> will guarantee it for you.</p><p>With event sourcing you have first to persist the event generated from a command (the message) using the Behavior trait and after that I can finally apply that command to the aggregate.</p><p>The <code>AggregateManager</code> is the entry point for a given Aggregate type. It forwards message to the correct Aggregate based on the id. It also stops children according to a <em>passivation strategy</em>.</p><p>In <code>Akka Persistence</code> you can have snapshots.</p><p><code>Akka</code> being a <code>PartialFunction</code> that goes from <code>Any</code> to <code>Unit</code> is to broad and doesn&#x27;t respect our domain. So we want to define something more stricter, done specifically for our domain.</p><p>We give to the scala compiler the responsibility about signaling if something is wrong about the usage of my commands and events.</p><pre style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd;padding:1em;margin:.5em 0;overflow:auto"><code style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd"><span class="token" style="color:#ffcc99">trait</span><span> ProtocolDef </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>  </span><span class="token" style="color:#ffcc99">trait</span><span> ProtocolCommand </span><span class="token" style="color:#ffcc99">extends</span><span> DomainCommand
</span><span>  </span><span class="token" style="color:#ffcc99">trait</span><span> ProtocolEvent </span><span class="token" style="color:#ffcc99">extends</span><span> DomainEvent
</span><span></span><span class="token" style="color:#6c6783">}</span><span>
</span>
<span></span><span class="token" style="color:#ffcc99">trait</span><span> Aggregate </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>  </span><span class="token" style="color:#ffcc99">type</span><span> Protocol </span><span class="token" style="color:#e09142">&lt;</span><span class="token" style="color:#e09142">:</span><span> ProtocolDef
</span><span>  </span><span class="token" style="color:#6c6783">// type member (similar to type parameter)</span><span>
</span><span>  </span><span class="token" style="color:#6c6783">// a type member can be referenced and so</span><span>
</span><span>  </span><span class="token" style="color:#6c6783">// you can navigate your type</span><span>
</span><span></span><span class="token" style="color:#6c6783">}</span><span>
</span>
<span></span><span class="token" style="color:#ffcc99">object</span><span> ProductProtocol </span><span class="token" style="color:#ffcc99">extends</span><span> ProtocolDef </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>  </span><span class="token" style="color:#ffcc99">case</span><span> </span><span class="token" style="color:#ffcc99">class</span><span> CreateProduct </span><span class="token" style="color:#6c6783">.</span><span class="token" style="color:#6c6783">.</span><span class="token" style="color:#6c6783">.</span><span> </span><span class="token" style="color:#ffcc99">extends</span><span> ProtocolCommand
</span><span>  </span><span class="token" style="color:#ffcc99">case</span><span> </span><span class="token" style="color:#ffcc99">class</span><span> ProductCreate </span><span class="token" style="color:#6c6783">.</span><span class="token" style="color:#6c6783">.</span><span class="token" style="color:#6c6783">.</span><span> </span><span class="token" style="color:#ffcc99">extends</span><span> ProtocolEvent
</span><span></span><span class="token" style="color:#6c6783">}</span><span>
</span>
<span></span><span class="token" style="color:#ffcc99">case</span><span> </span><span class="token" style="color:#ffcc99">class</span><span> Product</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#6c6783">.</span><span class="token" style="color:#6c6783">.</span><span class="token" style="color:#6c6783">.</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#ffcc99">extends</span><span> Aggregate </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>  </span><span class="token" style="color:#ffcc99">type</span><span> Protocol </span><span class="token" style="color:#e09142">=</span><span> ProductProtocol</span><span class="token" style="color:#6c6783">.</span><span class="token" style="color:#ffcc99">type</span><span>
</span><span>  </span><span class="token" style="color:#6c6783">// so aggregate Product responds to</span><span>
</span><span>  </span><span class="token" style="color:#6c6783">// protocol of type ProductProtocol</span><span>
</span><span>  </span><span class="token" style="color:#6c6783">// they are bounded</span><span>
</span><span></span><span class="token" style="color:#6c6783">}</span><span>
</span>
<span></span><span class="token" style="color:#ffcc99">trait</span><span> Behavior</span><span class="token" style="color:#6c6783">[</span><span> A </span><span class="token" style="color:#e09142">&lt;</span><span class="token" style="color:#e09142">:</span><span> Aggregate </span><span class="token" style="color:#6c6783">]</span><span> </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>  </span><span class="token" style="color:#ffcc99">type</span><span> AggregateType </span><span class="token" style="color:#e09142">:</span><span> A
</span><span>  </span><span class="token" style="color:#ffcc99">type</span><span> Command</span><span class="token" style="color:#e09142">:</span><span> AggregateType#Protocol#ProtocolCommand
</span><span>  </span><span class="token" style="color:#ffcc99">type</span><span> Event </span><span class="token" style="color:#e09142">=</span><span> AggregateType#Protocol#Protocolvent
</span>
<span>  </span><span class="token" style="color:#6c6783">// AggregateType bounds Command and Event to be only of that type</span><span>
</span><span>  </span><span class="token" style="color:#6c6783">// you will have compile error</span><span>
</span>
<span>  </span><span class="token" style="color:#ffcc99">def</span><span> validate</span><span class="token" style="color:#6c6783">(</span><span>cmd</span><span class="token" style="color:#e09142">:</span><span> Command</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#e09142">:</span><span> Event
</span><span>  </span><span class="token" style="color:#ffcc99">def</span><span> applyEvent</span><span class="token" style="color:#6c6783">(</span><span>evt</span><span class="token" style="color:#e09142">:</span><span> Event</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#e09142">:</span><span> AggregateType
</span><span></span><span class="token" style="color:#6c6783">}</span></code></pre><p>With this strategy we use the type system in our favour to create a sound domain.</p><p>Now we want to make our behavior more reactive.</p><pre style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd;padding:1em;margin:.5em 0;overflow:auto"><code style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd"><span class="token" style="color:#ffcc99">def</span><span> validate</span><span class="token" style="color:#6c6783">(</span><span>cmd</span><span class="token" style="color:#e09142">:</span><span> Command</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#e09142">:</span><span> Future</span><span class="token" style="color:#6c6783">[</span><span>DomainEvent</span><span class="token" style="color:#6c6783">]</span></code></pre><p>With <code>Future</code> the problem is that some command can take more time than another one so there could be a problem with order arrival of a <code>DomainEvent</code>. A <code>Future</code> will return instantly so the actor will consume the next message from the mailbox.</p><p>We can have two types of aggregate:</p><ul><li><strong>Authoritative</strong>: can validate everything it receives grabbing information from other systems</li><li><strong>Authomonus</strong>: can validate everything it receives without the necessity to ask outside of itself</li></ul><p>Aggregate needs to be open to async programming.</p><pre style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd;padding:1em;margin:.5em 0;overflow:auto"><code style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd"><span class="token" style="color:#ffcc99">def</span><span> validate</span><span class="token" style="color:#6c6783">(</span><span>cmd</span><span class="token" style="color:#e09142">:</span><span> Command</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#e09142">:</span><span> Future</span><span class="token" style="color:#6c6783">[</span><span>Seq</span><span class="token" style="color:#6c6783">[</span><span>DomainEvent</span><span class="token" style="color:#6c6783">]</span><span class="token" style="color:#6c6783">]</span></code></pre><p>One command can also release more than one event.</p><p>Never apply an event async. Always sync!</p><p>The read model needs to work the same way as the write model, so it has to process one event ad the time in a stream. There is a <code>ProjectionActor</code> that subscribe to a stream (with <code>Akka Persistence Query</code>) and until the Projection has finished applying that event, it won&#x27;t work on another one. <code>ProjectionActor</code> is responsible for doing backpressure on the stream.</p><p>Generally you have one <code>Actor</code> per <code>AggregateId</code>.</p><p>To handle, let&#x27;s say, with good performance, all the commands end events, it&#x27;s good to return a <code>Future</code> instead of the value so that you can process them in a different executor. This aims to not overwhelm the actor system executor with <em>business logic</em> work. To do that, you need to <em>switch</em> the nature of your Actor from <em>normal</em> (when it is able to process every event) to <em>busy</em> meaning that it doesn&#x27;t process anything until the previous task has ended.</p><p>This is the <code>Busy</code> state:</p><pre style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd;padding:1em;margin:.5em 0;overflow:auto"><code style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd"><span>  </span><span class="token" style="color:#ffcc99">private</span><span> </span><span class="token" style="color:#ffcc99">def</span><span> busy</span><span class="token" style="color:#e09142">:</span><span> Receive </span><span class="token" style="color:#e09142">=</span><span> </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>    </span><span class="token" style="color:#ffcc99">val</span><span> busyReceive</span><span class="token" style="color:#e09142">:</span><span> Receive </span><span class="token" style="color:#e09142">=</span><span> </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>      </span><span class="token" style="color:#ffcc99">case</span><span> Successful</span><span class="token" style="color:#6c6783">(</span><span>events</span><span class="token" style="color:#6c6783">,</span><span> nextState</span><span class="token" style="color:#6c6783">,</span><span> origSender</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#ffcc99">=&gt;</span><span> onSuccess</span><span class="token" style="color:#6c6783">(</span><span>events</span><span class="token" style="color:#6c6783">,</span><span> nextState</span><span class="token" style="color:#6c6783">,</span><span> origSender</span><span class="token" style="color:#6c6783">)</span><span>
</span><span>      </span><span class="token" style="color:#ffcc99">case</span><span> failedCmd</span><span class="token" style="color:#e09142">:</span><span> FailedCommand                  </span><span class="token" style="color:#ffcc99">=&gt;</span><span> onFailure</span><span class="token" style="color:#6c6783">(</span><span>failedCmd</span><span class="token" style="color:#6c6783">)</span><span>
</span><span>      </span><span class="token" style="color:#ffcc99">case</span><span> TypedCommand</span><span class="token" style="color:#6c6783">(</span><span>cmd</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#ffcc99">=&gt;</span><span>
</span><span>        log</span><span class="token" style="color:#6c6783">.</span><span>debug</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#ffcc99">&quot;aggregate &#x27;{}&#x27; received {} while processing another command&quot;</span><span class="token" style="color:#6c6783">,</span><span> identifier</span><span class="token" style="color:#6c6783">,</span><span> cmd</span><span class="token" style="color:#6c6783">)</span><span>
</span><span>        stash</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#6c6783">)</span><span>
</span><span>    </span><span class="token" style="color:#6c6783">}</span><span>
</span>    defaultReceive orElse busyReceive
<span>  </span><span class="token" style="color:#6c6783">}</span></code></pre><p>This is the <code>Available</code> state:</p><pre style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd;padding:1em;margin:.5em 0;overflow:auto"><code style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd"><span>    </span><span class="token" style="color:#ffcc99">val</span><span> receive</span><span class="token" style="color:#e09142">:</span><span> Receive </span><span class="token" style="color:#e09142">=</span><span> </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>      </span><span class="token" style="color:#ffcc99">case</span><span> TypedCommand</span><span class="token" style="color:#6c6783">(</span><span>cmd</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#ffcc99">=&gt;</span><span>
</span><span>        log</span><span class="token" style="color:#6c6783">.</span><span>debug</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#ffcc99">&quot;aggregate &#x27;{}&#x27; received cmd: {}&quot;</span><span class="token" style="color:#6c6783">,</span><span> identifier</span><span class="token" style="color:#6c6783">,</span><span> cmd</span><span class="token" style="color:#6c6783">)</span><span>
</span><span>        </span><span class="token" style="color:#ffcc99">val</span><span> eventualTimeout </span><span class="token" style="color:#e09142">=</span><span>
</span><span>          after</span><span class="token" style="color:#6c6783">(</span><span>duration </span><span class="token" style="color:#e09142">=</span><span> commandTimeout</span><span class="token" style="color:#6c6783">,</span><span> using </span><span class="token" style="color:#e09142">=</span><span> context</span><span class="token" style="color:#6c6783">.</span><span>system</span><span class="token" style="color:#6c6783">.</span><span>scheduler</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>            Future</span><span class="token" style="color:#6c6783">.</span><span>failed</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#ffcc99">new</span><span> TimeoutException</span><span class="token" style="color:#6c6783">(</span><span>s</span><span class="token" style="color:#ffcc99">&quot;Async command took more than $commandTimeout to complete: $cmd&quot;</span><span class="token" style="color:#6c6783">)</span><span class="token" style="color:#6c6783">)</span><span>
</span><span>          </span><span class="token" style="color:#6c6783">}</span><span>
</span><span>        </span><span class="token" style="color:#ffcc99">val</span><span> eventualEvents </span><span class="token" style="color:#e09142">=</span><span> interpreter</span><span class="token" style="color:#6c6783">.</span><span>applyCommand</span><span class="token" style="color:#6c6783">(</span><span>aggregateState</span><span class="token" style="color:#6c6783">,</span><span> cmd</span><span class="token" style="color:#6c6783">)</span><span>
</span><span>        </span><span class="token" style="color:#ffcc99">val</span><span> eventWithTimeout </span><span class="token" style="color:#e09142">=</span><span> Future firstCompletedOf Seq</span><span class="token" style="color:#6c6783">(</span><span>eventualEvents</span><span class="token" style="color:#6c6783">,</span><span> eventualTimeout</span><span class="token" style="color:#6c6783">)</span><span>
</span><span>        </span><span class="token" style="color:#ffcc99">val</span><span> origSender </span><span class="token" style="color:#e09142">=</span><span> sender</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#6c6783">)</span><span>
</span><span>        eventWithTimeout map </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>          </span><span class="token" style="color:#ffcc99">case</span><span> </span><span class="token" style="color:#6c6783">(</span><span>events</span><span class="token" style="color:#6c6783">,</span><span> nextState</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#ffcc99">=&gt;</span><span> Successful</span><span class="token" style="color:#6c6783">(</span><span>events</span><span class="token" style="color:#6c6783">,</span><span> nextState</span><span class="token" style="color:#6c6783">,</span><span> origSender</span><span class="token" style="color:#6c6783">)</span><span>
</span><span>        </span><span class="token" style="color:#6c6783">}</span><span> recover </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>          </span><span class="token" style="color:#ffcc99">case</span><span> NonFatal</span><span class="token" style="color:#6c6783">(</span><span>cause</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#ffcc99">=&gt;</span><span> FailedCommand</span><span class="token" style="color:#6c6783">(</span><span>cmd</span><span class="token" style="color:#6c6783">,</span><span> cause</span><span class="token" style="color:#6c6783">,</span><span> origSender</span><span class="token" style="color:#6c6783">)</span><span>
</span><span>        </span><span class="token" style="color:#6c6783">}</span><span> pipeTo </span><span class="token" style="color:#ffcc99">self</span><span>
</span><span>        changeState</span><span class="token" style="color:#6c6783">(</span><span>Busy</span><span class="token" style="color:#6c6783">)</span><span>
</span><span>    </span><span class="token" style="color:#6c6783">}</span></code></pre><p>As taken from the library <a href="https://github.com/strongtyped/fun-cqrs"><code>fun.CQRS</code></a> discussed in the talk.</p> </div></article></main><div class="layout_backToHome__1vZsp"><a href="/">← Back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"2017-07-16-field-guide-to-ddd-cqrs-with-akka","c":"## Notes on \"field Guide to DDD/CQRS with Akka\"\n\nThis is are the notes as seen on this talk at Devoxxx Belgium:\n\n\u003ciframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/fQkKu4tTgCE?rel=0\u0026amp;controls=0\u0026amp;showinfo=0\" frameborder=\"0\" allowfullscreen\u003e\u003c/iframe\u003e\n\nLet's begin\n- aggregate is responsible for consistency *(DDD)*\n- you can only modify one aggregate per transaction *(DDD)*\n- write model receives commands and produce events *(CQRS)*\n- strict consistency on write model side *(DDD/CQRS)*\n- read models are created from events *(CQRS)*\n- eventual consistency if asynch *(CQRS/ES)*\n- events can be stored and replayed (ES)\n\nNow we will se what operation we should implement for CQRS (in a non-reactive way)\n\n```scala\ntrait DomainCommand\ntrait DomainEvent\ntrait Aggregate\n\ntrait Behavior {\n  // this is part of the constructor\n  // it has to validate the DomainComman then it produces an event\n  // only if DomainCommand is valid\n  def validate(cmd: DomainCommand) : DomainEvent\n\n  // once the first event is created we use this method to creat an aggregate\n  def applyEvent(evt: DomainEvent) : Aggregate\n\n  // we have to separate method because:\n  // 1) we want to write code between validation and application of an event\n  // 2) in case of replay, we don't have commands, just events\n\n  // this method validates a command against an existing aggregate\n  def validate(cmd: DomainCommand, agg: Aggregate) : DomainEvent\n\n  // application of an event on the aggregate\n  // aggregate is immutable, so we produce a new aggregate every time we use this apply event\n  def applyEvent(evt: DomainEvent, agg: Aggregate) : Aggregate\n}\n```\n\nIn Akka the main component is a `PartialFunction[Any,Unit]` that will consume any type and will return a `Unit` . It's too broad and we know, given a command in input, which domain we will produce.\n\nAkka is an actor system. We send messages to an *actor* which we cannot manipulate directly, we use its `ActorRef`.\n\nThe message will go to the `Actor` mailbox and the `Actor` will consume it when it is ready to do so.\n\nAn `Actor`can have an internal mutable state but it cannot be accessed from outside.\n\nAn `Actor` stays in memory until dies or it's terminated. With `Akka Persistence` we can save the events we send after processing a message and so we can then recover a state.\n\nAn `Actor` has a receive method that can handle messages that comes from the system. If that `Actor` will receive a message it cannot handle, will just ignore it. It will send it to a *dead letter queue*.\n\nThe `Actor` will collect messages in the `Mailbox` until it is not ready to read another one. In the `Mailbox` messages are kept in order of arrival. `Akka` will guarantee it for you.\n\nWith event sourcing you have first to persist the event generated from a command (the message) using the Behavior trait and after that I can finally apply that command to the aggregate.\n\nThe `AggregateManager` is the entry point for a given Aggregate type. It forwards message to the correct Aggregate based on the id. It also stops children according to a *passivation strategy*.\n\nIn `Akka Persistence` you can have snapshots.\n\n`Akka` being a `PartialFunction` that goes from `Any` to `Unit` is to broad and doesn't respect our domain. So we want to define something more stricter, done specifically for our domain.\n\nWe give to the scala compiler the responsibility about signaling if something is wrong about the usage of my commands and events.\n\n```scala\ntrait ProtocolDef {\n  trait ProtocolCommand extends DomainCommand\n  trait ProtocolEvent extends DomainEvent\n}\n\ntrait Aggregate {\n  type Protocol \u003c: ProtocolDef\n  // type member (similar to type parameter)\n  // a type member can be referenced and so\n  // you can navigate your type\n}\n\nobject ProductProtocol extends ProtocolDef {\n  case class CreateProduct ... extends ProtocolCommand\n  case class ProductCreate ... extends ProtocolEvent\n}\n\ncase class Product(...) extends Aggregate {\n  type Protocol = ProductProtocol.type\n  // so aggregate Product responds to\n  // protocol of type ProductProtocol\n  // they are bounded\n}\n\ntrait Behavior[ A \u003c: Aggregate ] {\n  type AggregateType : A\n  type Command: AggregateType#Protocol#ProtocolCommand\n  type Event = AggregateType#Protocol#Protocolvent\n\n  // AggregateType bounds Command and Event to be only of that type\n  // you will have compile error\n\n  def validate(cmd: Command) : Event\n  def applyEvent(evt: Event) : AggregateType\n}\n```\n\nWith this strategy we use the type system in our favour to create a sound domain.\n\nNow we want to make our behavior more reactive.\n\n```scala\ndef validate(cmd: Command) : Future[DomainEvent]\n```\n\nWith `Future` the problem is that some command can take more time than another one so there could be a problem with order arrival of a `DomainEvent`. A `Future` will return instantly so the actor will consume the next message from the mailbox.\n\nWe can have two types of aggregate:\n\n- **Authoritative**: can validate everything it receives grabbing information from other systems\n- **Authomonus**: can validate everything it receives without the necessity to ask outside of itself\n\nAggregate needs to be open to async programming.\n\n```scala\ndef validate(cmd: Command) : Future[Seq[DomainEvent]]\n```\n\nOne command can also release more than one event.\n\nNever apply an event async. Always sync!\n\nThe read model needs to work the same way as the write model, so it has to process one event ad the time in a stream. There is a `ProjectionActor` that subscribe to a stream (with `Akka Persistence Query`) and until the Projection has finished applying that event, it won't work on another one. `ProjectionActor` is responsible for doing backpressure on the stream.\n\nGenerally you have one `Actor` per `AggregateId`.\n\nTo handle, let's say, with good performance, all the commands end events, it's good to return a `Future` instead of the value so that you can process them in a different executor. This aims to not overwhelm the actor system executor with *business logic* work. To do that, you need to *switch* the nature of your Actor from *normal* (when it is able to process every event) to *busy* meaning that it doesn't process anything until the previous task has ended.\n\nThis is the `Busy` state:\n\n```scala\n  private def busy: Receive = {\n    val busyReceive: Receive = {\n      case Successful(events, nextState, origSender) =\u003e onSuccess(events, nextState, origSender)\n      case failedCmd: FailedCommand                  =\u003e onFailure(failedCmd)\n      case TypedCommand(cmd) =\u003e\n        log.debug(\"aggregate '{}' received {} while processing another command\", identifier, cmd)\n        stash()\n    }\n    defaultReceive orElse busyReceive\n  }\n```\n\nThis is the `Available` state:\n\n```scala\n    val receive: Receive = {\n      case TypedCommand(cmd) =\u003e\n        log.debug(\"aggregate '{}' received cmd: {}\", identifier, cmd)\n        val eventualTimeout =\n          after(duration = commandTimeout, using = context.system.scheduler) {\n            Future.failed(new TimeoutException(s\"Async command took more than $commandTimeout to complete: $cmd\"))\n          }\n        val eventualEvents = interpreter.applyCommand(aggregateState, cmd)\n        val eventWithTimeout = Future firstCompletedOf Seq(eventualEvents, eventualTimeout)\n        val origSender = sender()\n        eventWithTimeout map {\n          case (events, nextState) =\u003e Successful(events, nextState, origSender)\n        } recover {\n          case NonFatal(cause) =\u003e FailedCommand(cmd, cause, origSender)\n        } pipeTo self\n        changeState(Busy)\n    }\n```\n\nAs taken from the library [`fun.CQRS`](https://github.com/strongtyped/fun-cqrs) discussed in the talk.\n","title":"Field Guide to DDD/CQRS With Akka","date":"2017-07-16"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"2017-07-16-field-guide-to-ddd-cqrs-with-akka"},"buildId":"usI8n7jxWBNz6mDmRqDbi","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-e750b8bf0c81a657f011.js"></script><script src="/_next/static/chunks/main-09a35a1efccce928cb9e.js" async=""></script><script src="/_next/static/chunks/webpack-ccf5ab034a524403276a.js" async=""></script><script src="/_next/static/chunks/framework.5e03480598ad1120f007.js" async=""></script><script src="/_next/static/chunks/commons.dee2ffe8ab5f8852fbb0.js" async=""></script><script src="/_next/static/chunks/pages/_app-693a52f134959e79e2e2.js" async=""></script><script src="/_next/static/chunks/10cf003e655e7be2119574cd9202224517114f06.88faf2b206d9aa1def0c.js" async=""></script><script src="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.59a0c659b24f5cfac152.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-9447264b1c0cf8b6e875.js" async=""></script><script src="/_next/static/usI8n7jxWBNz6mDmRqDbi/_buildManifest.js" async=""></script><script src="/_next/static/usI8n7jxWBNz6mDmRqDbi/_ssgManifest.js" async=""></script></body></html>