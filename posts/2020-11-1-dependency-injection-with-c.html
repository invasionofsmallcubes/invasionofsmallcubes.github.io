<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="description" content="this is my note taking app, shared with everybody"/><meta property="og:image" content="https://og-image.now.sh/Welcome%20to%20the%20Invasion%20Of%20Small%20Cubes.png?theme=dark&amp;md=0&amp;fontSize=75px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><meta name="og:title" content="Welcome to the Invasion Of Small Cubes"/><meta name="twitter:card" content="summary_large_image"/><script src="tracking.js"></script><title>One way of doing dependency injection with C</title><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/8549f512080405e68560.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8549f512080405e68560.css" data-n-g=""/><link rel="preload" href="/_next/static/css/8940758a4d427170012c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8940758a4d427170012c.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-27ce3cd164fb94df60e7.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.9707fddd9ae5927c17c3.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.44ec10f6e415a8ca6263.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-e21097dd67dbafb50e0f.js" as="script"/><link rel="preload" href="/_next/static/chunks/10cf003e655e7be2119574cd9202224517114f06.141ecfc5fd01254381c9.js" as="script"/><link rel="preload" href="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.1bed55e3a27ef4b763d1.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-26b94c598112f16fa107.js" as="script"/></head><body><div id="__next"><div class="layout_container__2t4v2"><header class="layout_header__2rhWq"><a href="/"><img src="/images/face.jpeg" class="layout_headerImage__2h5On utils_borderCircle__13qdJ" alt="The Invasion of Small Cubes"/></a><h2 class="utils_headingLg__de7p0"><a class="utils_colorInherit__3Gudf" href="/">The Invasion of Small Cubes</a></h2></header><main><article><h1 class="utils_headingXl__1XecN">One way of doing dependency injection with C</h1><div class="utils_lightText__12Ckm"><time dateTime="2020-11-01">November 1, 2020</time></div><div><p>I&#x27;m teaching C programming at the Danish Technical University and I was trying to explain to my students a little bit of how to test.</p><p>I find this cool library called <a href="http://www.jera.com/techinfo/jtns/jtn002.html">MinUnit</a> which is just 4 lines of code:</p><pre style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd;padding:1em;margin:.5em 0;overflow:auto"><code class="language-c" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd"><span class="token" style="color:#6c6783">/* file: minunit.h */</span><span>
</span><span></span><span class="token macro directive-hash" style="color:#9a86fd">#</span><span class="token macro" style="color:#ffcc99">define</span><span class="token macro" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#9a86fd">mu_assert</span><span class="token macro expression" style="color:#6c6783">(</span><span class="token macro expression" style="color:#9a86fd">message</span><span class="token macro expression" style="color:#6c6783">,</span><span class="token macro expression" style="color:#9a86fd"> test</span><span class="token macro expression" style="color:#6c6783">)</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#ffcc99">do</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#6c6783">{</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#ffcc99">if</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#6c6783">(</span><span class="token macro expression" style="color:#e09142">!</span><span class="token macro expression" style="color:#6c6783">(</span><span class="token macro expression" style="color:#9a86fd">test</span><span class="token macro expression" style="color:#6c6783">)</span><span class="token macro expression" style="color:#6c6783">)</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#ffcc99">return</span><span class="token macro expression" style="color:#9a86fd"> message</span><span class="token macro expression" style="color:#6c6783">;</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#6c6783">}</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#ffcc99">while</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#6c6783">(</span><span class="token macro expression" style="color:#e09142">0</span><span class="token macro expression" style="color:#6c6783">)</span><span>
</span><span></span><span class="token macro directive-hash" style="color:#9a86fd">#</span><span class="token macro" style="color:#ffcc99">define</span><span class="token macro" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#9a86fd">mu_run_test</span><span class="token macro expression" style="color:#6c6783">(</span><span class="token macro expression" style="color:#9a86fd">test</span><span class="token macro expression" style="color:#6c6783">)</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#ffcc99">do</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#6c6783">{</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#ffcc99">char</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#e09142">*</span><span class="token macro expression" style="color:#9a86fd">message </span><span class="token macro expression" style="color:#e09142">=</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#9a86fd">test</span><span class="token macro expression" style="color:#6c6783">(</span><span class="token macro expression" style="color:#6c6783">)</span><span class="token macro expression" style="color:#6c6783">;</span><span class="token macro expression" style="color:#9a86fd"> tests_run</span><span class="token macro expression" style="color:#e09142">++</span><span class="token macro expression" style="color:#6c6783">;</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro" style="color:#6c6783">\</span><span class="token macro" style="color:#9a86fd">
</span><span class="token macro" style="color:#9a86fd">                                </span><span class="token macro expression" style="color:#ffcc99">if</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#6c6783">(</span><span class="token macro expression" style="color:#9a86fd">message</span><span class="token macro expression" style="color:#6c6783">)</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#ffcc99">return</span><span class="token macro expression" style="color:#9a86fd"> message</span><span class="token macro expression" style="color:#6c6783">;</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#6c6783">}</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#ffcc99">while</span><span class="token macro expression" style="color:#9a86fd"> </span><span class="token macro expression" style="color:#6c6783">(</span><span class="token macro expression" style="color:#e09142">0</span><span class="token macro expression" style="color:#6c6783">)</span><span>
</span><span></span><span class="token" style="color:#ffcc99">extern</span><span> </span><span class="token" style="color:#ffcc99">int</span><span> tests_run</span><span class="token" style="color:#6c6783">;</span></code></pre><p>This allows you to organize a test file this way:</p><pre style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd;padding:1em;margin:.5em 0;overflow:auto"><code class="language-c" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd"><span class="token macro directive-hash" style="color:#9a86fd">#</span><span class="token macro" style="color:#ffcc99">include</span><span class="token macro" style="color:#9a86fd"> </span><span class="token macro" style="color:#ffcc99">&quot;minunit.h&quot;</span><span>
</span><span></span><span class="token macro directive-hash" style="color:#9a86fd">#</span><span class="token macro" style="color:#ffcc99">include</span><span class="token macro" style="color:#9a86fd"> </span><span class="token macro" style="color:#ffcc99">&quot;function_under_test_source.c&quot;</span><span>
</span><span></span><span class="token" style="color:#ffcc99">static</span><span> </span><span class="token" style="color:#ffcc99">char</span><span> </span><span class="token" style="color:#e09142">*</span><span class="token" style="color:#9a86fd">test_ac1</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>    </span><span class="token" style="color:#9a86fd">mu_assert</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#ffcc99">&quot;max char, should broke, it didn&#x27;t&quot;</span><span class="token" style="color:#6c6783">,</span><span>
</span><span>              </span><span class="token" style="color:#9a86fd">function_under_test</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#e09142">==</span><span> </span><span class="token" style="color:#e09142">1</span><span class="token" style="color:#6c6783">)</span><span class="token" style="color:#6c6783">;</span><span>
</span><span>    </span><span class="token" style="color:#ffcc99">return</span><span> </span><span class="token" style="color:#e09142">0</span><span class="token" style="color:#6c6783">;</span><span>
</span><span></span><span class="token" style="color:#6c6783">}</span><span>
</span><span></span><span class="token" style="color:#ffcc99">static</span><span> </span><span class="token" style="color:#ffcc99">char</span><span> </span><span class="token" style="color:#e09142">*</span><span class="token" style="color:#9a86fd">all_tests</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>    </span><span class="token" style="color:#9a86fd">mu_run_test</span><span class="token" style="color:#6c6783">(</span><span>test_ac1</span><span class="token" style="color:#6c6783">)</span><span class="token" style="color:#6c6783">;</span><span>
</span><span>    </span><span class="token" style="color:#ffcc99">return</span><span> </span><span class="token" style="color:#e09142">0</span><span class="token" style="color:#6c6783">;</span><span>
</span><span></span><span class="token" style="color:#6c6783">}</span><span>
</span><span></span><span class="token" style="color:#ffcc99">int</span><span> </span><span class="token" style="color:#9a86fd">main</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#ffcc99">int</span><span> argc</span><span class="token" style="color:#6c6783">,</span><span> </span><span class="token" style="color:#ffcc99">char</span><span> </span><span class="token" style="color:#e09142">*</span><span class="token" style="color:#e09142">*</span><span>argv</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>    </span><span class="token" style="color:#ffcc99">char</span><span> </span><span class="token" style="color:#e09142">*</span><span>result </span><span class="token" style="color:#e09142">=</span><span> </span><span class="token" style="color:#9a86fd">all_tests</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#6c6783">)</span><span class="token" style="color:#6c6783">;</span><span>
</span><span>    </span><span class="token" style="color:#ffcc99">if</span><span> </span><span class="token" style="color:#6c6783">(</span><span>result </span><span class="token" style="color:#e09142">!=</span><span> </span><span class="token" style="color:#e09142">0</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>        </span><span class="token" style="color:#9a86fd">printf</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#ffcc99">&quot;%s\n&quot;</span><span class="token" style="color:#6c6783">,</span><span> result</span><span class="token" style="color:#6c6783">)</span><span class="token" style="color:#6c6783">;</span><span>
</span><span>    </span><span class="token" style="color:#6c6783">}</span><span> </span><span class="token" style="color:#ffcc99">else</span><span> </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>        </span><span class="token" style="color:#9a86fd">printf</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#ffcc99">&quot;ALL TESTS PASSED\n&quot;</span><span class="token" style="color:#6c6783">)</span><span class="token" style="color:#6c6783">;</span><span>
</span><span>    </span><span class="token" style="color:#6c6783">}</span><span>
</span><span>    </span><span class="token" style="color:#9a86fd">printf</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#ffcc99">&quot;Tests run: %d\n&quot;</span><span class="token" style="color:#6c6783">,</span><span> tests_run</span><span class="token" style="color:#6c6783">)</span><span class="token" style="color:#6c6783">;</span><span>
</span>
<span>    </span><span class="token" style="color:#ffcc99">return</span><span> result </span><span class="token" style="color:#e09142">!=</span><span> </span><span class="token" style="color:#e09142">0</span><span class="token" style="color:#6c6783">;</span><span>
</span><span></span><span class="token" style="color:#6c6783">}</span></code></pre><p>Really cool. I was writing a function to read a string from input stream that doesn&#x27;t overflow if put more chars than allowed ones. (I can&#x27;t post it since it&#x27;s part of the assignment for my students)</p><p>But I was having the problem of testing it because it uses <code>getchar</code> from <code>stdio.h</code>.</p><p>I wanted to teach my students how to test, and hopefully a little bit of TDD. With pointer to function is actually quite easy:</p><pre style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd;padding:1em;margin:.5em 0;overflow:auto"><code class="language-c" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd"><span class="token" style="color:#ffcc99">int</span><span> </span><span class="token" style="color:#9a86fd">get_string</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#ffcc99">char</span><span> s</span><span class="token" style="color:#6c6783">[</span><span class="token" style="color:#6c6783">]</span><span class="token" style="color:#6c6783">,</span><span> </span><span class="token" style="color:#ffcc99">int</span><span> maxChar</span><span class="token" style="color:#6c6783">,</span><span> </span><span class="token" style="color:#ffcc99">int</span><span> </span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#e09142">*</span><span>getchar</span><span class="token" style="color:#6c6783">)</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#6c6783">)</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#6c6783">{</span></code></pre><p>This means I&#x27;m passing a pointer to a function called <code>getchar</code> that return an int and accept no arguments, like the actual <code>getchar</code> from <code>stdio.h</code>.</p><p>So you can create a mock function to mimic I/O like:</p><pre style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd;padding:1em;margin:.5em 0;overflow:auto"><code class="language-c" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd"><span class="token" style="color:#ffcc99">const</span><span> </span><span class="token" style="color:#ffcc99">char</span><span> </span><span class="token" style="color:#e09142">*</span><span>mock_getchar_data_ptr</span><span class="token" style="color:#6c6783">;</span><span>
</span>
<span></span><span class="token" style="color:#ffcc99">char</span><span>        </span><span class="token" style="color:#9a86fd">mock_getchar</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>    </span><span class="token" style="color:#ffcc99">return</span><span> </span><span class="token" style="color:#e09142">*</span><span>mock_getchar_data_ptr</span><span class="token" style="color:#e09142">++</span><span class="token" style="color:#6c6783">;</span><span>
</span><span></span><span class="token" style="color:#6c6783">}</span></code></pre><p>and on the test you just create the string you want to read.</p><pre style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd;padding:1em;margin:.5em 0;overflow:auto"><code class="language-c" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#2a2734;color:#9a86fd"><span class="token" style="color:#ffcc99">static</span><span> </span><span class="token" style="color:#ffcc99">char</span><span> </span><span class="token" style="color:#e09142">*</span><span class="token" style="color:#9a86fd">test_ac2</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#6c6783">{</span><span>
</span><span>    </span><span class="token" style="color:#ffcc99">char</span><span> text</span><span class="token" style="color:#6c6783">[</span><span class="token" style="color:#e09142">100</span><span class="token" style="color:#6c6783">]</span><span class="token" style="color:#6c6783">;</span><span>
</span><span>    mock_getchar_data_ptr </span><span class="token" style="color:#e09142">=</span><span> </span><span class="token" style="color:#ffcc99">&quot;\nhello!\n&quot;</span><span class="token" style="color:#6c6783">;</span><span> </span><span class="token" style="color:#6c6783">// the initial \n is there because I&#x27;m using scanf on production code (main.c)</span><span>
</span><span>    </span><span class="token" style="color:#9a86fd">get_string</span><span class="token" style="color:#6c6783">(</span><span>text</span><span class="token" style="color:#6c6783">,</span><span> </span><span class="token" style="color:#e09142">100</span><span class="token" style="color:#6c6783">,</span><span> mock_getchar</span><span class="token" style="color:#6c6783">)</span><span class="token" style="color:#6c6783">;</span><span>
</span><span>    </span><span class="token" style="color:#9a86fd">mu_assert</span><span class="token" style="color:#6c6783">(</span><span class="token" style="color:#ffcc99">&quot;text is hello&quot;</span><span class="token" style="color:#6c6783">,</span><span> </span><span class="token" style="color:#9a86fd">strcmp</span><span class="token" style="color:#6c6783">(</span><span>text</span><span class="token" style="color:#6c6783">,</span><span> </span><span class="token" style="color:#ffcc99">&quot;hello!&quot;</span><span class="token" style="color:#6c6783">)</span><span> </span><span class="token" style="color:#e09142">==</span><span> </span><span class="token" style="color:#e09142">0</span><span class="token" style="color:#6c6783">)</span><span class="token" style="color:#6c6783">;</span><span>
</span><span>    </span><span class="token" style="color:#ffcc99">return</span><span> </span><span class="token" style="color:#e09142">0</span><span class="token" style="color:#6c6783">;</span><span>
</span><span></span><span class="token" style="color:#6c6783">}</span></code></pre><p>Pretty neat, right?</p><p>I&#x27;m no expert on this so if you have any advices, just write me on <a href="https://twitter.com/IsTDDDeadYet">twitter</a></p> </div></article></main><div class="layout_backToHome__1vZsp"><a href="/">← Back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"2020-11-1-dependency-injection-with-c","c":"\nI'm teaching C programming at the Danish Technical University and I was trying to explain to my students a little bit of how to test.\n\nI find this cool library called [MinUnit](http://www.jera.com/techinfo/jtns/jtn002.html) which is just 4 lines of code:\n\n~~~ c\n/* file: minunit.h */\n#define mu_assert(message, test) do { if (!(test)) return message; } while (0)\n#define mu_run_test(test) do { char *message = test(); tests_run++; \\\n                                if (message) return message; } while (0)\nextern int tests_run;\n~~~\n\nThis allows you to organize a test file this way:\n~~~ c\n#include \"minunit.h\"\n#include \"function_under_test_source.c\"\nstatic char *test_ac1() {\n    mu_assert(\"max char, should broke, it didn't\",\n              function_under_test() == 1);\n    return 0;\n}\nstatic char *all_tests() {\n    mu_run_test(test_ac1);\n    return 0;\n}\nint main(int argc, char **argv) {\n    char *result = all_tests();\n    if (result != 0) {\n        printf(\"%s\\n\", result);\n    } else {\n        printf(\"ALL TESTS PASSED\\n\");\n    }\n    printf(\"Tests run: %d\\n\", tests_run);\n\n    return result != 0;\n}\n~~~\n\nReally cool. I was writing a function to read a string from input stream that doesn't overflow if put more chars than allowed ones. (I can't post it since it's part of the assignment for my students)\n\nBut I was having the problem of testing it because it uses `getchar` from `stdio.h`.\n\nI wanted to teach my students how to test, and hopefully a little bit of TDD. With pointer to function is actually quite easy:\n\n~~~ c\nint get_string(char s[], int maxChar, int (*getchar)()) {\n~~~\n\nThis means I'm passing a pointer to a function called `getchar` that return an int and accept no arguments, like the actual `getchar` from `stdio.h`.\n\nSo you can create a mock function to mimic I/O like:\n~~~ c\nconst char *mock_getchar_data_ptr;\n\nchar        mock_getchar() {\n    return *mock_getchar_data_ptr++;\n}\n~~~\n\nand on the test you just create the string you want to read.\n\n~~~ c\nstatic char *test_ac2() {\n    char text[100];\n    mock_getchar_data_ptr = \"\\nhello!\\n\"; // the initial \\n is there because I'm using scanf on production code (main.c)\n    get_string(text, 100, mock_getchar);\n    mu_assert(\"text is hello\", strcmp(text, \"hello!\") == 0);\n    return 0;\n}\n~~~\n\nPretty neat, right?\n\nI'm no expert on this so if you have any advices, just write me on [twitter](https://twitter.com/IsTDDDeadYet)","title":"One way of doing dependency injection with C","date":"2020-11-01"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"2020-11-1-dependency-injection-with-c"},"buildId":"fOr5mCnYx3WMqNS6SivmO","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-fa276ba060a4a8ac7eef.js"></script><script src="/_next/static/chunks/main-27ce3cd164fb94df60e7.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.9707fddd9ae5927c17c3.js" async=""></script><script src="/_next/static/chunks/commons.44ec10f6e415a8ca6263.js" async=""></script><script src="/_next/static/chunks/pages/_app-e21097dd67dbafb50e0f.js" async=""></script><script src="/_next/static/chunks/10cf003e655e7be2119574cd9202224517114f06.141ecfc5fd01254381c9.js" async=""></script><script src="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.1bed55e3a27ef4b763d1.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-26b94c598112f16fa107.js" async=""></script><script src="/_next/static/fOr5mCnYx3WMqNS6SivmO/_buildManifest.js" async=""></script><script src="/_next/static/fOr5mCnYx3WMqNS6SivmO/_ssgManifest.js" async=""></script></body></html>